
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Apache Felix - Multiple Cardinality References - CodeAffectionado</title>
  <meta name="author" content="jeff.downing@latchd.com">

  
  <meta name="description" content="Apache Felix - Multiple Cardinality References In the last example, we made a simple greeter interface and a hello world class that used it in &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codeaffectionado.com/labs-and-tutorials/osgi/apache-felix-multiple-cardinality-references">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="CodeAffectionado" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43174506-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">CodeAffectionado</a></h1>
  
    <h2>Shared learning for code enthusiasts</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codeaffectionado.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">News</a></li>
  <li><a href="/labs-and-tutorials/">Labs And Tutorials</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Apache Felix - Multiple Cardinality References</h1>
    <p class="meta">








  


<time datetime="2014-10-20T10:01:00-04:00" pubdate data-updated="true"></time></p>
  </header>
  
  <p>In the <a href="/labs-and-tutorials/osgi/apache-felix-maven-to-bndtools">last example</a>, we made a simple greeter interface and a hello world class that used it in Bndtools. A Gogo shell command was then used to call the service and get back a string greeting. The reference was bound using the @Reference annotation in the command class and we stored this information into a single field. But, what would happen if many greeters were registered as services? What if all of them were needed?</p>

<p>In this tutorial, we will change our project to support multiple cardinality references and make the command to run all the greeters that it finds when it&rsquo;s typed.</p>

<h2 id="id-bb2e0d598ec6aa8a6d571355ba7459d7">1 A Quick Review</h2>

<p>The original command used the @Reference annotation. It used this annotation to set a field called greeter to the first service it found. Our class looked like this:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>The Original Greeter Gogo Command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">commands</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.api.Greeter</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">aQute.bnd.annotation.component.Reference</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreetCommand</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Greeter</span> <span class="n">greeter</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Reference</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGreeter</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">greeter</span> <span class="o">=</span> <span class="n">greeter</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">greet</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">greeter</span><span class="o">.</span><span class="na">greet</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>This works great if we think that only one greeter will ever be registered as a service. But,
what if we wanted the command to save all of the greeters it found and use them all?</p>

<h2 id="id-418c8c0359af5543bcbd1ba20d70d0a5">2 Modify the Command for Multiple References</h2>

<p>We need to change our field to store more than one service at a time. So lets change it to a list of greeters. That means:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Original Field Declaration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Greeter</span> <span class="n">greeter</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>becomes</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>New Field Declaration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Greeter</span><span class="o">&gt;</span> <span class="n">greeters</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Now we need to change the signature of the <code>setGreeter</code> method. We need to have Felix give us all the references one at a time that it finds. To do that change the signature:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Original Reference Property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Reference</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGreeter</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span><span class="o">){</span>
</span><span class='line'>     <span class="k">this</span><span class="o">.</span><span class="na">greeter</span> <span class="o">=</span> <span class="n">greeter</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>to</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>New Reference Property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Reference</span><span class="o">(</span><span class="n">multiple</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGreeter</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span><span class="o">){</span>
</span><span class='line'>  <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">greeters</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">greeters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Greeter</span><span class="o">&gt;();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(&amp;</span><span class="n">quot</span><span class="o">;</span><span class="n">Adding</span> <span class="o">&amp;</span><span class="n">quot</span><span class="o">;+</span><span class="n">greeter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>  <span class="k">this</span><span class="o">.</span><span class="na">greeters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">greeter</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p><em>Note: You can see the effects of this annotation change if you later break apart the component.xml file it generates. Inside you will notice that multiple=true sets the cardinality to &ldquo;1..n&rdquo; and the dynamic=true sets a property called policy to &ldquo;dynamic&rdquo;. The final component.xml file is shown at the end of this tutorial for reference.</em></p>

<h2 id="id-592dd488823d7f58507f217393551799">3 Create an Unbind Method</h2>

<p>When we just had a single field, it was ok for the variable to hold a reference or a null. However, now that we are dealing with a collection of references, we need this field to have zero to many references, but never null. To do this, we need to create a method that will remove references from the collection when they are removed from OSGi.</p>

<p>Lets add a <code>unsetGreeter</code> method to unbind the references. The name alone is enough for the framework to find it. The framework is smart enough to know that if the method was named <code>setSomething</code> then <code>unsetSomething</code> must be the opposite.</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Creating Method To Unbind References</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsetGreeter</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span><span class="o">){</span>
</span><span class='line'>     <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(&amp;</span><span class="n">quot</span><span class="o">;</span><span class="n">Removing</span> <span class="o">&amp;</span><span class="n">quot</span><span class="o">;+</span><span class="n">greeter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>     <span class="k">this</span><span class="o">.</span><span class="na">greeters</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">greeter</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Since these methods represent a property, set and unset are the best ways to name them. However, if you wanted to have unset be named something out there, you can. Adding the unbind property to the annotation will let you use whatever you would like. An example is:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Using The Unbind Property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Reference</span><span class="o">(</span><span class="n">multiple</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span><span class="n">unbind</span><span class="o">=</span><span class="n">wackaWackaMethod</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>
Now that we are done with the shell command, the class looks like this:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>The Final Gogo Command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">commands</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.felix.service.command.CommandProcessor</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.api.Greeter</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">aQute.bnd.annotation.component.Component</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">aQute.bnd.annotation.component.Reference</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Component</span><span class="o">(</span><span class="n">properties</span><span class="o">={</span>
</span><span class='line'>      <span class="n">CommandProcessor</span><span class="o">.</span><span class="na">COMMAND_SCOPE</span><span class="o">+&amp;</span><span class="n">quot</span><span class="o">;:</span><span class="n">String</span><span class="o">=</span><span class="n">tutorial</span><span class="o">&amp;</span><span class="n">quot</span><span class="o">;,</span>
</span><span class='line'>      <span class="n">CommandProcessor</span><span class="o">.</span><span class="na">COMMAND_FUNCTION</span><span class="o">+&amp;</span><span class="n">quot</span><span class="o">;:</span><span class="n">String</span><span class="o">=</span><span class="n">greet</span><span class="o">&amp;</span><span class="n">quot</span><span class="o">;</span>
</span><span class='line'><span class="o">},</span><span class="n">provide</span><span class="o">=</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreetCommand</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Greeter</span><span class="o">&gt;</span> <span class="n">greeters</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@Reference</span><span class="o">(</span><span class="n">multiple</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGreeter</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span><span class="o">){</span>
</span><span class='line'>      <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">greeters</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span><span class='line'>          <span class="k">this</span><span class="o">.</span><span class="na">greeters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Greeter</span><span class="o">&gt;();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(&amp;</span><span class="n">quot</span><span class="o">;</span><span class="n">Adding</span> <span class="o">&amp;</span><span class="n">quot</span><span class="o">;+</span><span class="n">greeter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">greeters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">greeter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsetGreeter</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span><span class="o">){</span>
</span><span class='line'>      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(&amp;</span><span class="n">quot</span><span class="o">;</span><span class="n">Removing</span> <span class="o">&amp;</span><span class="n">quot</span><span class="o">;+</span><span class="n">greeter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">greeters</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">greeter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">greet</span><span class="o">(){</span>
</span><span class='line'>      <span class="k">for</span><span class="o">(</span><span class="n">Greeter</span> <span class="n">greeter</span> <span class="o">:</span> <span class="n">greeters</span><span class="o">){</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">greeter</span><span class="o">.</span><span class="na">greet</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>This is all we needed to do to make our bundle operate like before, but I promised to show mulitple references. In order to do that we need more greeters.</p>

<p>Note: In the next sections I&rsquo;m going to breeze through creating a new greeter bundle. If you get stuck and can&rsquo;t remember how to do it in Bndtools, the <a href="/labs-and-tutorials/osgi/apache-felix-maven-to-bndtools">previous tutorial</a> had sections that can help.</p>

<h2 id="id-578f1574d68ddcfeaa3c39aef185c289">4 Create an Alternate Implementation</h2>

<p>Using Eclipse and Bndtools, create a new Bundle Descriptor. Name this one <code>greeter-bundle-impl2</code> and inside it create the following implementation.:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Alternate Greeter Implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl2</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.api.Greeter</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">aQute.bnd.annotation.component.Component</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Component</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloUniverseGreeter</span> <span class="kd">implements</span> <span class="n">Greeter</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">greet</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;Hello Universe!&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Now add this new implementation to the private packages of its <code>greeter-bundle-impl2.bnd</code> file and set the Declarative services to <em>Bnd Annotations</em>.</p>

<h2 id="id-00a9348ca39914089684373fe25279d7">5 Setup and Run</h2>

<p>Now in our <code>bnd.bnd</code> file again, click on the run tab and drag our new <code>greeter-bundle-impl2</code> file into the run bundles, if it isn&rsquo;t already there. When you click on the Run OSGi button now and run the tutorial:greet command, notice what you see:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Alternate Greeter Implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">___________________________</span>
</span><span class='line'><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Apache</span> <span class="n">Felix</span> <span class="n">Gogo</span>
</span><span class='line'>
</span><span class='line'><span class="n">g</span><span class="o">!</span> <span class="nl">tutorial:</span><span class="n">greet</span>
</span><span class='line'><span class="n">Adding</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">HelloWorldGreeter</span>
</span><span class='line'><span class="n">Adding</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl2</span><span class="o">.</span><span class="na">HelloUniverseGreeter</span>
</span><span class='line'><span class="n">Hello</span> <span class="n">World</span><span class="o">!</span>
</span><span class='line'><span class="n">Hello</span> <span class="n">Universe</span><span class="o">!</span>
</span><span class='line'><span class="n">Removing</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">HelloWorldGreeter</span>
</span><span class='line'><span class="n">Removing</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl2</span><span class="o">.</span><span class="na">HelloUniverseGreeter</span>
</span><span class='line'><span class="n">g</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>When the command was ran, the command found two services and set them in the collection. It then called both of them. Once complete the service references were unset. In most cases this is OK. But what if we wanted the greeters to be loaded and remain loaded as long as the command was registered?</p>

<p>Lets change this behavior by telling the framework that the command should be activated immediately. To do this we need to add one more property to the command&rsquo;s annotation:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Binding Immeadiately</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Component</span><span class="o">(</span><span class="n">properties</span><span class="o">={</span>
</span><span class='line'>      <span class="n">CommandProcessor</span><span class="o">.</span><span class="na">COMMAND_SCOPE</span><span class="o">+&amp;</span><span class="n">quot</span><span class="o">;:</span><span class="n">String</span><span class="o">=</span><span class="n">tutorial</span><span class="o">&amp;</span><span class="n">quot</span><span class="o">;,</span>
</span><span class='line'>      <span class="n">CommandProcessor</span><span class="o">.</span><span class="na">COMMAND_FUNCTION</span><span class="o">+&amp;</span><span class="n">quot</span><span class="o">;:</span><span class="n">String</span><span class="o">=</span><span class="n">greet</span><span class="o">&amp;</span><span class="n">quot</span><span class="o">;</span>
</span><span class='line'><span class="o">},</span><span class="n">provide</span><span class="o">=</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">immediate</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Notice after the Object.class we added a new property for <code>immediate=true</code>. Now lets run this again.</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Binding Immeadiately</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">____________________________</span>
</span><span class='line'><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Apache</span> <span class="n">Felix</span> <span class="n">Gogo</span>
</span><span class='line'>
</span><span class='line'><span class="n">g</span><span class="o">!</span> <span class="n">Adding</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">HelloWorldGreeter</span>
</span><span class='line'><span class="n">Adding</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl2</span><span class="o">.</span><span class="na">HelloUniverseGreeter</span>
</span><span class='line'>
</span><span class='line'><span class="n">g</span><span class="o">!</span> <span class="nl">tutorial:</span><span class="n">greet</span>
</span><span class='line'><span class="n">Hello</span> <span class="n">World</span><span class="o">!</span>
</span><span class='line'><span class="n">Hello</span> <span class="n">Universe</span><span class="o">!</span>
</span><span class='line'><span class="n">g</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>When the bundle started, the references were bound immediately. They will now stay that way unless the implementation bundles are stopped or uninstalled. If you stop impl or impl2 in the console, watch what happens. This dynamic setting and unsetting is what makes OSGi so powerful.</p>

<h2 id="id-710b6869e7581a0c111f98a5af383e4d">6 A Peek into the Component XML File</h2>

<p>So the annotation changes we made did some interesting things to the reference section of the component file. You can see it by double clicking on the greeter-bundle-commands.jar. It now looks like this:</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>The Component XML File Now</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;org.bhn.training.commands.GreetCommand&quot;</span> <span class="na">immediate=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;implementation</span> <span class="na">class=</span><span class="s">&quot;org.bhn.training.commands.GreetCommand&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;service&gt;</span>
</span><span class='line'>    <span class="nt">&lt;provide</span> <span class="na">interface=</span><span class="s">&quot;java.lang.Object&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/service&gt;</span>
</span><span class='line'>  <span class="nt">&lt;reference</span> <span class="na">name=</span><span class="s">&quot;greeter&quot;</span> <span class="na">cardinality=</span><span class="s">&quot;1..n&quot;</span> <span class="na">policy=</span><span class="s">&quot;dynamic&quot;</span> <span class="na">interface=</span><span class="s">&quot;org.bhn.training.api.Greeter&quot;</span> <span class="na">bind=</span><span class="s">&quot;setGreeter&quot;</span> <span class="na">unbind=</span><span class="s">&quot;unsetGreeter&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;osgi.command.function&quot;</span> <span class="na">type=</span><span class="s">&quot;String&quot;</span> <span class="na">value=</span><span class="s">&quot;greet&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;osgi.command.scope&quot;</span> <span class="na">type=</span><span class="s">&quot;String&quot;</span> <span class="na">value=</span><span class="s">&quot;tutorial&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/component&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>We can now see the immediate attribute is filled out on the component. We can also see the cardinality, policy and unbind attributes have been filled out. When makes the component.xml file by hand, it&rsquo;s important to note that these attributes are not always named the same as the annotations. Nor are the values of these attribute the same.</p>

<h2 id="id-290612199861c31d1036b185b4e69b75">7 Summary</h2>

<p>In this tutorial, we changed an existing project to support multiple reference binding. By doing so, we asked for every service that implemented a specific interface to be bound. In our next tutorial we will learn more about the concept of filtering references so that we can keep certain references from binding, yet allow others.</p>

  
    <footer>
      <p class="meta">
        
        








  


<time datetime="2014-10-20T10:01:00-04:00" pubdate data-updated="true"></time>
        
      </p>
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.codeaffectionado.com/labs-and-tutorials/osgi/apache-felix-multiple-cardinality-references/index.html" data-via="mrjepp" data-counturl="http://www.codeaffectionado.com/labs-and-tutorials/osgi/apache-felix-multiple-cardinality-references/index.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

      
    </footer>
  
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
  <section>
  <h1>Tutorial Steps</h1>
  <ol style="margin-left: 1.3em;"><li style="list-style:inherit;"><a href="#id-bb2e0d598ec6aa8a6d571355ba7459d7">A Quick Review</a></li><li style="list-style:inherit;"><a href="#id-418c8c0359af5543bcbd1ba20d70d0a5">Modify the Command for Multiple References</a></li><li style="list-style:inherit;"><a href="#id-592dd488823d7f58507f217393551799">Create an Unbind Method</a></li><li style="list-style:inherit;"><a href="#id-578f1574d68ddcfeaa3c39aef185c289">Create an Alternate Implementation</a></li><li style="list-style:inherit;"><a href="#id-00a9348ca39914089684373fe25279d7">Setup and Run</a></li><li style="list-style:inherit;"><a href="#id-710b6869e7581a0c111f98a5af383e4d">A Peek into the Component XML File</a></li><li style="list-style:inherit;"><a href="#id-290612199861c31d1036b185b4e69b75">Summary</a></li></ol>
  </section>
<section>
	<h1>Lab/Tutorial Sections</h1>
	<ul id="recent_posts">
      <li class="post">
        <a href="/labs-and-tutorials/osgi/">OSGi</a>
      </li>
      <li>
      	<a href="/labs-and-tutorials/apache-jackrabbit/">Apache Jackrabbit</a>
      </li>
  </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/16/hey-whats-with-this-wordpress-site/">Hey? Whats With This Wordpress Site?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/16/new-osgi-tutorial-posted/">New OSGi Tutorial on Bndtools Posted</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/03/labs-and-tutorials-slash-apache-jackrabbit-slash-importing-xml/">The Most Important JavaScript Videos You Might Watch This Year</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/19/newest-osgi-tutorial-additions/">Newest OSGi Additions</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/17/apache-jackrabbit-starting-out/">Apache Jackrabbit - Starting From Scratch Tutorial Up</a>
      </li>
    
  </ul>
</section>

<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/114996005873710645329?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - jeff.downing@latchd.com -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'aggrolearning';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.codeaffectionado.com/labs-and-tutorials/osgi/apache-felix-multiple-cardinality-references/index.html';
        var disqus_url = 'http://www.codeaffectionado.com/labs-and-tutorials/osgi/apache-felix-multiple-cardinality-references/index.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
