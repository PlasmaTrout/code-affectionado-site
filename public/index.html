
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CodeAffectionado</title>
  <meta name="author" content="jeff.downing@latchd.com">

  
  <meta name="description" content="In our previous example tutorial we created an OSGi bundle using declarative services. However, to test our bundle we needed to create a Gogo Shell &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codeaffectionado.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="CodeAffectionado" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43174506-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">CodeAffectionado</a></h1>
  
    <h2>Aggressive learning for code enthusiasts</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codeaffectionado.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/15/apache-felix-paxexam-and-unit-testing-felix-bundles/">Apache Felix - Pax Exam and Unit Testing Felix Bundles</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-15T16:58:00-04:00" pubdate data-updated="true">Aug 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In our previous <a href="/osgi/2013/08/14/apache-felix---modifying-our-first-bundle-for-declaritive-services/">example tutorial</a> we created an OSGi bundle using declarative services. However, to test our bundle we needed to create a Gogo Shell command and run it manually to validate that the bundle was operating correctly. In this tutorial we will remove that command binding and use a unit testing framework to test our bundle.</p>

<p>If you haven&rsquo;t done the first few bundle tutorials mentioned above you can grab the source at:</p>

<figure class='code'><figcaption><span>Lab Quick Start Code</span><a href='https://github.com/PlasmaTrout/greeter-bundle-lab4'>GitHub </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git@github.com:PlasmaTrout/greeter-bundle-lab4.git
</span></code></pre></td></tr></table></div></figure>


<h2>Requirements</h2>

<ul>
<li>Apache Felix (See <a href="/osgi/2013/08/09/felix-from-the-ground-up">Starting From Scratch</a>)</li>
<li>Apache Maven</li>
<li>IDE Of Choice (Preferably IntelliJ IDEA)</li>
<li>Internet Connection (For Maven Repositories)</li>
<li>GIT (Needed To Pull Previous Project)</li>
</ul>


<h2>Audience</h2>

<p>Typically, this is Lab #4 in a classroom environment, however anyone that wishes can use this tutorial to create a tutorial bundle. The typical audience already understands what OSGi is and that Apache Felix is just one implementation of an OSGi framework.</p>

<h2>What We Are Going To Do</h2>

<ol>
<li>Remove Our Command Class and Declarative Services XML File</li>
<li>Add A Few Maven Dependencies</li>
<li>Retrofit Our Existing JUnit Test To Use PaxRunner</li>
<li>Build Our Application and Run Unit Tests</li>
</ol>


<h2>Remove Our Command Class and Declarative Services XML File</h2>

<p>In this step we are going to find and remove our command package from the project tree. Once we get to Apache Sling (which is where we are going BTW) we can just make some web pages to display our results. So delete the command package and the files in it and remove the greetcommandcomponent.xml file as well. We are done with it for now.</p>

<p>So now our JAR file is a bit smaller. If we take a look we can see the command is no more:</p>

<figure class='code'><figcaption><span>Bundle Jar Contents </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>450 Wed Aug 14 16:03:34 EDT 2013 META-INF/MANIFEST.MF
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 META-INF/
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 OSGI-INF/
</span><span class='line'>333 Wed Aug 14 15:58:16 EDT 2013 OSGI-INF/greetercomponent.xml
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 org/
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 org/bhn/
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 org/bhn/training/
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 org/bhn/training/api/
</span><span class='line'>155 Wed Aug 14 16:03:32 EDT 2013 org/bhn/training/api/Greeter.class
</span><span class='line'>0 Wed Aug 14 16:03:34 EDT 2013 org/bhn/training/impl/
</span><span class='line'>482 Wed Aug 14 16:03:32 EDT 2013 org/bhn/training/impl/SimpleStringGreeterImpl.class</span></code></pre></td></tr></table></div></figure>


<p>After your done, take a look at your POM.xml and remove the Service-Component entry for the file you just removed. We also need to add some magical lines for our Pax Exam tests, so it should end up like:</p>

<figure class='code'><figcaption><span>Modifying The Maven Plugin </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>maven-bundle-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.3.7<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
</span><span class='line'>    <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;instructions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;Bundle-Name&gt;</span>${project.name}<span class="nt">&lt;/Bundle-Name&gt;</span>
</span><span class='line'>            <span class="nt">&lt;Bundle-SymbolicName&gt;</span>${project.artifactId}<span class="nt">&lt;/Bundle-SymbolicName&gt;</span>
</span><span class='line'>            <span class="nt">&lt;Export-Package&gt;</span>org.bhn.training.api<span class="nt">&lt;/Export-Package&gt;</span>
</span><span class='line'>            <span class="nt">&lt;Service-Component&gt;</span>OSGI-INF/greetercomponent.xml<span class="nt">&lt;/Service-Component&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/instructions&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>        <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>            <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>                <span class="nt">&lt;goal&gt;</span>manifest<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'><span class="nt">&lt;/plugin&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The new goal is to ensure that the manifest is actually written at a different part of the lifecycle. It&rsquo;s really just to improve the process of testing the bundle. Without this line you would end up with errors indicating that the manifest didn&rsquo;t exist during the testing phase. Putting this line in ensures that it really will exist prior to the test being run.</p>

<h2>Add A Few Maven Dependencies</h2>

<p>So now we need to add a few Maven dependencies. I won&rsquo;t explain them, just know that they are requirements for Pax Exam and are available in their documentation. We are also going to scope most of them to test only anyways. We won&rsquo;t be deploying them. In your POM.xml add the following dependency chain:</p>

<figure class='code'><figcaption><span>Pax Exam POM Dependencies </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!--Used for Pax Exam unit testing only --&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.ops4j.pax.exam<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>pax-exam-container-native<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.5.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.ops4j.pax.exam<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>pax-exam-junit4<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.5.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.ops4j.pax.exam<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>pax-exam-link-mvn<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.5.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.ops4j.pax.url<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>pax-url-aether<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>1.4.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>org.apache.felix.framework<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>3.2.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>logback-core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>0.9.20<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>0.9.20<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats really all we had to do in this step. Its probably best that we run a <strong>mvn package</strong> or <strong>nv test</strong> just to make sure we have no Maven errors.</p>

<h2>Retrofit Our Existing JUnit Test To Use PaxRunner</h2>

<p>We already have a unit test that was created with the quick start archetype. Up to now we have been mostly ignoring it. Lets make it do some work. Locate your AppTest.java file and lets rename it to GreetingPaxExamTest.java so it describes itself a bit.</p>

<p>Now lets decorate the top of it with some annotations that will help Pax Exam pick up on its existance (I&rsquo;m omitting the imports that are needed to support these, I&rsquo;m hoping your IDE does some work here):</p>

<figure class='code'><figcaption><span>Decorating Our Test Class With Some Annotations </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">JUnit4TestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@ExamReactorStrategy</span><span class="o">(</span><span class="n">AllConfinedStagedReactorFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreeterPaxExamTest</span>
</span><span class='line'>    <span class="kd">extends</span> <span class="n">TestCase</span>
</span><span class='line'><span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first is a common annotation to change what runner (test system) that the unit test will run on. Without this annotation, Maven will default to its own runner and we don&rsquo;t want that in this case. We want it to use JUnit 4.8.2&rsquo;s test runner.</p>

<p>The second tells Pax Exam what kind of strategy to use when starting and stopping the container. With our selection a brand new test container is started and stopped for each test that is run. The only other option is EagerSingleStagedReactorFactory which is explained in Pax Exam&rsquo;s documentation. Our statement is the default so its really not needed but let&rsquo;s leave it in anyways.</p>

<p>Now we need to setup our class body to support the way unit tests work for our runner. The first thing we need is a configuration section:</p>

<figure class='code'><figcaption><span>Test Class Configuration Method </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Configuration</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Option</span><span class="o">[]</span> <span class="nf">config</span><span class="o">(){</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">options</span><span class="o">(</span>
</span><span class='line'>            <span class="n">mavenBundle</span><span class="o">(</span><span class="s">&quot;org.apache.felix&quot;</span><span class="o">,</span><span class="s">&quot;org.apache.felix.scr&quot;</span><span class="o">,</span><span class="s">&quot;1.6.2&quot;</span><span class="o">),</span>
</span><span class='line'>            <span class="n">bundle</span><span class="o">(</span><span class="s">&quot;reference:file:target/classes&quot;</span><span class="o">),</span>
</span><span class='line'>            <span class="n">junitBundles</span><span class="o">()</span>
</span><span class='line'>    <span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This method is called by the runner to know how to load the OSGi framework up with bundles prior to the test launching. The syntax is a little strange, but just know that Pax Exam exposed a few static helpers that attempts to make things easier.</p>

<p>Now we need is an actual test, lets modify the create one to look like:</p>

<figure class='code'><figcaption><span>Test Class Test Method </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">simpleGreetingImplCheck</span><span class="o">(){</span>
</span><span class='line'>  <span class="c1">// test will go here  </span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So far we really aren&rsquo;t testing anything specific, but just to test your setup run <strong>mvn test</strong> and watch what happens now.</p>

<p>All of that logging that flew by was telling your about a framework startup and shutdown. Pretty fast for starting and stopping a bundle.</p>

<p>So we want to test our greeter service. We know that typically we ask the context for an instance of the service that implements an interface. So our basic question usually is &ldquo;Hey framework, I need whatever implements this interface.&rdquo; the framework usually responds &ldquo;ok&rdquo; and gives it to you. To do that in our test, we inject a variable. Which is very similar to what you will do in you code in later tutorials actually. Lets create the following field in our test class:</p>

<figure class='code'><figcaption><span>Test Class Injection Example </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Inject</span>
</span><span class='line'><span class="kd">private</span> <span class="n">Greeter</span> <span class="n">greeter</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note: The import for inject is javax.inject.Inject. Some IDE&rsquo;s will put googles first, just know you want the javax annotation.</em></p>

<p>Now lets use that interface in our test. Notice that I <strong>WILL NOT</strong> instantiate anything the framework will handle that. Change your test to look like:</p>

<figure class='code'><figcaption><span>Test Class Unit Test </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">simpleGreetingImplCheck</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">testValue</span> <span class="o">=</span> <span class="n">greeter</span><span class="o">.</span><span class="na">greet</span><span class="o">();</span>
</span><span class='line'>    <span class="n">assertEquals</span><span class="o">(</span><span class="n">testValue</span><span class="o">,</span><span class="s">&quot;Hello World Fail!&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just in case your having trouble, the final test class should look like the following:</p>

<figure class='code'><figcaption><span> (GreeterPaxExamTest.java)</span> <a href='/downloads/code/GreeterPaxExamTest.java'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.api.Greeter</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">junit.framework.TestCase</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.ops4j.pax.exam.Option</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.ops4j.pax.exam.junit.Configuration</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.ops4j.pax.exam.junit.ExamReactorStrategy</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.ops4j.pax.exam.junit.JUnit4TestRunner</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.ops4j.pax.exam.spi.reactors.AllConfinedStagedReactorFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">ops4j</span><span class="o">.</span><span class="na">pax</span><span class="o">.</span><span class="na">exam</span><span class="o">.</span><span class="na">CoreOptions</span><span class="o">.*;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">JUnit4TestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@ExamReactorStrategy</span><span class="o">(</span><span class="n">AllConfinedStagedReactorFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreeterPaxExamTest</span>
</span><span class='line'>    <span class="kd">extends</span> <span class="n">TestCase</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Greeter</span> <span class="n">greeter</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Configuration</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Option</span><span class="o">[]</span> <span class="nf">config</span><span class="o">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">options</span><span class="o">(</span>
</span><span class='line'>                <span class="n">mavenBundle</span><span class="o">(</span><span class="s">&quot;org.apache.felix&quot;</span><span class="o">,</span><span class="s">&quot;org.apache.felix.scr&quot;</span><span class="o">,</span><span class="s">&quot;1.6.2&quot;</span><span class="o">),</span>
</span><span class='line'>                <span class="c1">//mavenBundle(&quot;org.bhn.training&quot;,&quot;greeter-bundle&quot;),</span>
</span><span class='line'>                <span class="n">bundle</span><span class="o">(</span><span class="s">&quot;reference:file:target/classes&quot;</span><span class="o">),</span>
</span><span class='line'>                <span class="n">junitBundles</span><span class="o">()</span>
</span><span class='line'>        <span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">simpleGreetingImplCheck</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">testValue</span> <span class="o">=</span> <span class="n">greeter</span><span class="o">.</span><span class="na">greet</span><span class="o">();</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="n">testValue</span><span class="o">,</span><span class="s">&quot;Hello World Fail!&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Build Our Application and Run Unit Tests</h2>

<p>Now all we have to do is run a <strong>mvn test</strong> and see if we are working properly. This test was designed to fail just to prove that it is actually working. If you scroll up a little in the text you will see the line:</p>

<figure class='code'><figcaption><span>Example Failure Message </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>GreeterPax ExamTest.simpleGreetingImplCheck:39 expected:&lt;Hello World[]!> but was:&lt;Hello World[ Fail]!></span></code></pre></td></tr></table></div></figure>


<p>This is due to our test case having the world fail in it. If we change it to just Hello World! it will pass.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/15/apache-felix-modifying-our-first-bundle-for-declarative-services/">Apache Felix - Modifying Our First Bundle for Declarative Services</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-15T15:53:00-04:00" pubdate data-updated="true">Aug 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In our previous <a href="/blog/2013/08/15/apache-felix-first-bundle/">example tutorial</a> we created an OSGi bundle in a programmatic fashion. In that bundle we registered two services into the service registry. While rather simple in implementation, the solution did depend heavily on use of the Activator class. And since only one Activator can be defined in a bundle, registering even more services would present a significant challenge on readability. We are going to neaten this up a bit and use some features of the R4 compendium known as Declarative Services. We will expound on it a little as we go along, but I encourage you to read the specifications on the <a href="http://www.osgi.org/Download/HomePage">OSGi Alliances Site</a>.</p>

<p>If you haven&rsquo;t done the first bundle tutorial mentioned above you can grab the source at:</p>

<figure class='code'><figcaption><span>Git Hub Quick Start</span><a href='https://github.com/PlasmaTrout/greeter-bundle-lab3'>GitHub </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git@github.com:PlasmaTrout/greeter-bundle-lab3.git
</span></code></pre></td></tr></table></div></figure>


<h2>Requirements</h2>

<ul>
<li>Apache Felix (See <a href="/blog/2013/08/14/apache-felix-starting-from-scratch/">Starting From Scratch</a>)</li>
<li>Apache Maven</li>
<li>IDE Of Choice (Preferably IntelliJ IDEA)</li>
<li>Internet Connection (For Maven Repositories)</li>
<li>GIT (Needed To Pull Previous Project)</li>
</ul>


<h2>Audience</h2>

<p>Typically, this is Lab #3 in a classroom environment, however anyone that wishes can use this tutorial to create a tutorial bundle. The typical audience already understands what OSGi is and that Apache Felix is just one implementation of an OSGi framework.</p>

<h2>What We Are Going To Do</h2>

<ol>
<li>Remove The Activator From The Project</li>
<li>Add A XML File For The Greeter Service To The Resources Directory</li>
<li>Add Another XML File For The Greet Command To The Resources Directory</li>
<li>Build, Deploy And Test</li>
</ol>


<h2>Remove The Activator From The Project</h2>

<p>So let&rsquo;s delete that Activator now. Just completely wipe it out of the project. When your finished with that edit your POM.xml and completely wipe out this line (we don&rsquo;t need it anymore):</p>

<figure class='code'><figcaption><span>Remove This Activator Line </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Bundle-Activator&gt;</span>org.bhn.training.SimpleActivator<span class="nt">&lt;/Bundle-Activator&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have any doubts as to whether its gone after a new build, just peek into the JAR file and make sure its gone. Mine looks something like this now (note no activator is inside the bundle):</p>

<figure class='code'><figcaption><span>Sample JAR Contents Now </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/api/
</span><span class='line'>155 Wed Aug 14 11:16:32 EDT 2013 org/bhn/training/api/Greeter.class
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/commands/
</span><span class='line'>1132 Wed Aug 14 11:16:32 EDT 2013 org/bhn/training/commands/GreeterCommands.class
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/impl/
</span><span class='line'>482 Wed Aug 14 11:16:32 EDT 2013 org/bhn/training/impl/SimpleStringGreeterImpl.class</span></code></pre></td></tr></table></div></figure>


<h2>Add A XML File For The Greeter Service To The Resources Directory</h2>

<p>Because we are using maven, we need to make some new directories and maven knows about so we can include resources into our project. Make a resources dir under main and then put a new dir under the resources dir called OSGI-INF. Our new directories path should look like:</p>

<figure class='code'><figcaption><span>Add A New Resource Path </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;&lt;Project>>/src/main/resources/OSGI-INF</span></code></pre></td></tr></table></div></figure>


<p>Now in the OSGI-INF directory, lets create a new file called greetercomponent.xml. The name is somewhat irrelevant, however I would name it something that indicates what component it is for. The reason is, each service will be in its own xml file. After a while component1, component2 and component3 won&rsquo;t help developers quickly find its configuration.</p>

<p>Now we are going to do the same job that we did in the Activator in a declarative manner. Modify your greetercomponent.xml file to look like the following:</p>

<figure class='code'><figcaption><span>Add A Declarative Services Component File (greetercomponent.xml)</span> <a href='/downloads/code/greetercomponent.xml'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;scr:component</span> <span class="na">name=</span><span class="s">&quot;GreeterComponent&quot;</span>
</span><span class='line'>               <span class="na">xmlns:scr=</span><span class="s">&quot;http://www.osgi.org/xmlns/scr/v1.2.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;implementation</span> <span class="na">scr:class=</span><span class="s">&quot;org.bhn.training.impl.SimpleStringGreeterImpl&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;service&gt;</span>
</span><span class='line'>        <span class="nt">&lt;scr:provide</span> <span class="na">interface=</span><span class="s">&quot;org.bhn.training.api.Greeter&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/service&gt;</span>
</span><span class='line'><span class="nt">&lt;/scr:component&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So interpreting this file is rather straight-forward. We are first declaring a component. What&rsquo;s a component. Well a component is really just a Java class that is declared in an XML document. Very similar to the concepts of beans if you are used to other Java terminologies. It has a name just for management in the framework. You can install other web consoles that help manage them by their component name.</p>

<p>Then we tell the component what its implementation class is, so it can create it when its needed.</p>

<p>Then we create a service and tell it what interface to provide, that is, register for us. That&rsquo;s all there really is to a simple service. However, before we can use this xml file, we need to tell the maven plugin to add a manifest entry for where to find it. That entry is known as the Service-Component entry. In our POM in the instructions for our bundle plugin lets add the following line:</p>

<figure class='code'><figcaption><span>Tell The Bundle The File Exists </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Service-Component&gt;</span>OSGI-INF/greetercomponent.xml<span class="nt">&lt;/Service-Component&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this line in the file you are ready to deploy to your framework. But before you do, you need to make sure another specific bundle is installed in the container. It&rsquo;s called the SCR Declarative Services bundle and it should be running. If not not sweat, pull up your OSGi console and enter:</p>

<figure class='code'><figcaption><span>Install Service Component Registry Bundle </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>felix:install http://mirror.sdunix.com/apache//felix/org.apache.felix.scr-1.6.2.jar
</span><span class='line'>felix:start X (where x is the number of the bundle)</span></code></pre></td></tr></table></div></figure>


<p>After you deploy your bundle. Pull up the <a href="http://localhost:8080/system/console">web console</a> and expand it. You should see your new manifest entry is present and you should have a new service id registered. This is a pretty good indication that everything went as planned, but lets add our command otherwise testing it won&rsquo;t be too easy.</p>

<h2>Add Another XML File For The Greet Command To The Resources Directory</h2>

<p>So lets add one more component file to the OSGI-INF directory. Lets add a greetcommandcomponent.xml file. And do something similar as the above example to register it. However, in this component, we need properties to set upon activation so we have some new elements to add to the definition:</p>

<figure class='code'><figcaption><span>Add A Command Declarative Services Component File (greetcommandcomponent.xml)</span> <a href='/downloads/code/greetcommandcomponent.xml'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;scr:component</span> <span class="na">name=</span><span class="s">&quot;GreetCommandComponent&quot;</span>
</span><span class='line'>               <span class="na">xmlns:scr=</span><span class="s">&quot;http://www.osgi.org/xmlns/scr/v1.2.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;implementation</span> <span class="na">scr:class=</span><span class="s">&quot;org.bhn.training.commands.GreeterCommands&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;service&gt;</span>
</span><span class='line'>        <span class="nt">&lt;scr:provide</span> <span class="na">interface=</span><span class="s">&quot;org.bhn.training.commands.GreeterCommands&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;osgi.command.scope&quot;</span> <span class="na">value=</span><span class="s">&quot;tutorialds&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;osgi.command.function&quot;</span><span class="nt">&gt;</span>greet<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/scr:provide&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/service&gt;</span>
</span><span class='line'><span class="nt">&lt;/scr:component&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we just add this to our manifest by changing our Service-Component entry to:</p>

<figure class='code'><figcaption><span>Add A Second Component File To The Maven Plugin </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Service-Component&gt;</span>OSGI-INF/greetercomponent.xml,
</span><span class='line'>            OSGI-INF/greetcommandcomponent.xml<span class="nt">&lt;/Service-Component&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Build, Deploy and Test</h2>

<p>So package this guy up with a <strong>mvn package</strong> and then deploy using your method of choice (for this one I used the web console personally). After its deployed and started you should see a new command in our console for <strong>tutorialds:greet</strong> and be able to call it. I did have some exceptions during the making of this tutorial and you may experience the same. The few things that happened to me were:</p>

<h3>IllegalStateExceptions</h3>

<p><em>ERROR: greeter-bundle (15): [GreeterComponent] Cannot register Component
java.lang.IllegalStateException: Invalid BundleContext</em></p>

<p>This occured mainly because I had a typo in one of the component files which confused Felix into writing some properties it shouldn&rsquo;t have. I think the name attribute was missing from one of the properties. However, even after fixing it, the exception stayed there until I restarted the whole framework.</p>

<h3>XmlParseExceptions</h3>

<p>Typically they come in a variety of flavors and they are usually due to badly formed xml documents. Mine came from a example in the R4 compendium that had a declarative services entry as the following:</p>

<figure class='code'><figcaption><span>Malformed Header </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;xml</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span> <span class="na">encoding=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which I pasted and didn&rsquo;t check, but its really supposed to be:</p>

<figure class='code'><figcaption><span>Standard Header </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the next tutorial I think we will kill the command on this bundle and then add PaxExam so we can unit test our product. Generating commands for each bundle to test them is not a feasible option for long term sustainability. PaxExam will allow us to run Felix as a part of our Maven test lifecycle and test our bundle.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/15/apache-felix-first-bundle/">Apache Felix - First Bundle the Programmatic Way</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-15T14:26:00-04:00" pubdate data-updated="true">Aug 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tutorial is designed to guide the reader through creating a very simple bundle example. For simplicity we will use the commit Greeter/Greet examples that are seen very often in OSGi tutorials. Since this is a classroom taught course, usually done in corporate environments, it&rsquo;s rather targeted on a specific IDE. However, if you wish to use an alternate environment the instructions should be diverse enough to support building on alternate platforms.</p>

<h2>Requirements</h2>

<ul>
<li>Apache Felix (See <a href="/blog/2013/08/15/apache-felix-starting-from-scratch/">Starting From Scratch</a>)</li>
<li>Apache Maven</li>
<li>IDE Of Choice (Preferably IntelliJ IDEA)</li>
<li>Internet Connection (For Maven Repositories)</li>
</ul>


<h2>Audience</h2>

<p>Typically, this is Lab #2 in a classroom environment, however anyone that wishes can use this tutorial to create a tutorial bundle. The typical audience already understands what OSGi is and that Apache Felix is just one implementation of an OSGi framework.</p>

<h2>What We Are Going To Do</h2>

<ol>
<li>Generate A Maven Quickstart Java Project</li>
<li>Change The POM</li>
<li>Add Some Code</li>
<li>Build And Deploy Our Bundle To Apache-Felix</li>
<li>Create A Gogo Command To Test The Code</li>
</ol>


<h2>Generate A Maven Quickstart Java Project</h2>

<p>We will use the command line to generate a new maven project(Using the IDE would take too many pictures and overhead from the presentation). First, create a directory that you wish to place the project in, we will just use our $HOME/projects directory in the examples. Then run the following command:</p>

<div>
  <pre><code class='bash'>mvn archetype:generate -DgroupId=org.bhn.training -DartifactId=greeter-bundle -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</code></pre>
</div>


<p>If you then open up IDEA and import an existing Maven project, you can select the new directory this command creates. At this point you have a very simple hello world application. You can compile and run this if you want, we are going to change it significantly though in the next few sections.</p>

<h2>Change The Pom</h2>

<p>If we want to build bundles instead of plain ole JARS we have to modify the plugins of the POM to support building a new type of packaging. While we are modifying the POM we really should add some dependencies to, just because we will need to write some code later that will require a few specific APIs.</p>

<p>Your starter project has a very simple minimal POM (which is why we chose it). So lets first add the plugins and configure then for making OSGi bundles. The main plugin we will need to add and configure is the maven-bundle-plugin. Its job is to create the necessary manifest additions needed. So just before the dependencies line, add in the following plugin:</p>

<figure class='code'><figcaption><span>POM Modification </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> <span class="nt">&lt;build&gt;</span>
</span><span class='line'>    <span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>        <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>maven-bundle-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>2.3.7<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>            <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>                <span class="nt">&lt;instructions&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;Bundle-Name&gt;</span>${project.name}<span class="nt">&lt;/Bundle-Name&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;Bundle-SymbolicName&gt;</span>${project.artifactId}<span class="nt">&lt;/Bundle-SymbolicName&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/instructions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/plugins&gt;</span>
</span><span class='line'><span class="nt">&lt;/build&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This plugins job is just to take the JAR and add the configuration instructions in MANIFEST.MF in the appropriate way. The only real difference between a JAR and an OSGi Bundle JAR is just some new attributes added to the manifest itself. In this case we are doing the bare minimum (for now). We also need to add some dependencies so lets add the following ones (if junit is in your dependencies already just delete it):</p>

<figure class='code'><figcaption><span>POM Dependencies </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>org.osgi.core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>1.4.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>4.8.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we add org.osgi.core and then we just add a current version of junit for testing. That should be all we need for now. There is one last thing we need to do though. See that link towards the top of your POM that specifies that packaging should be JAR? Lets change that to bundle.</p>

<figure class='code'><figcaption><span>Change Packaging Type </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;groupId&gt;</span>com.bhn.training<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'><span class="nt">&lt;artifactId&gt;</span>greeter-bundle<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'><span class="nt">&lt;packaging&gt;</span>bundle<span class="nt">&lt;/packaging&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our plugin will kick in and give us the correct output. If we run a <strong>mvn package</strong> we should get a build success and just o make sure our plugins are working lets go into the target directory of your project. There you should see a new jar file names greeter-bundle-1.0-SNAPSHOT.jar or something similar. If you execute the command:</p>

<figure class='code'><figcaption><span>Unpack And Examine Manifest </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jar -xvf greeter-bundle-1.0-SNAPSHOT.jar META-INF/MANIFEST.MF
</span><span class='line'>cat META-INF/MANIFEST.MF</span></code></pre></td></tr></table></div></figure>


<p>You should see now that the manifest included with this JAR is a bit different from a normal JAR. For instance a normal JAR might look something like this:</p>

<figure class='code'><figcaption><span>Normal JAR Manifest </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Manifest-Version: 1.0
</span><span class='line'>Archiver-Version: Plexus Archiver
</span><span class='line'>Created-By: Apache Maven
</span><span class='line'>Built-By: PlasmaTrout
</span><span class='line'>Build-Jdk: 1.6.0_51</span></code></pre></td></tr></table></div></figure>


<p>However our new one, ends up very similar to:</p>

<figure class='code'><figcaption><span>OSGi JAR Manifest </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Manifest-Version: 1.0
</span><span class='line'>Bnd-LastModified: 1376419554357
</span><span class='line'>Build-Jdk: 1.6.0_51
</span><span class='line'>Built-By: PlasmaTrout
</span><span class='line'>Bundle-ManifestVersion: 2
</span><span class='line'>Bundle-Name: greeter-bundle
</span><span class='line'>Bundle-SymbolicName: greeter-bundle
</span><span class='line'>Bundle-Version: 1.0.0.SNAPSHOT
</span><span class='line'>Created-By: Apache Maven Bundle Plugin
</span><span class='line'>Export-Package: org.bhn.training;version="1.0.0.SNAPSHOT"
</span><span class='line'>Tool: Bnd-1.50.0</span></code></pre></td></tr></table></div></figure>


<p>Notice the extra entries? These will be become crucial to understand later, but just know that since our plugin really only specified two (name and symbolic name), quite a few more were actually written to the manifest by default thanks to the maven plugin.</p>

<h2>Add Some Code</h2>

<p>Now that we can build like a bundle, we should be writing some code to act like one. First lets create two new packages, lets create a org.bhn.training.api and an org.bhn.training.impl. This will allow us to minimally keep our APIs and Implementations seperate for organizational purposes only. In a perfect world these really will be seperate bundles, but thats out of scope for this tutorial.</p>

<p>In our <strong>api</strong> package lets create an interface called Greeter. Greeter should look like the following:</p>

<figure class='code'><figcaption><span>Greeter API Interface </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">api</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Greeter</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="nf">greet</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see it, really won&rsquo;t do much, but it gets the point across. Now lets go to our <strong>impl</strong> package and add an implementation class SimpleStringGreeterImpl.java with the code:</p>

<figure class='code'><figcaption><span>Greeter Implementation </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">impl</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.api.Greeter</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleStringGreeterImpl</span> <span class="kd">implements</span> <span class="n">Greeter</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">greet</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;Hello World!&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have an implementation of a simple service. What we need to do is write some code to register that service in whats called a service registry. Then anyone who needs to be greeted can simple use the interface to get an instance to the service.</p>

<p>The programmatic way to do this is to create an Activator. An activator in a bundle is represented as a class that implements the interface <a href="http://www.osgi.org/javadoc/r4v43/core/org/osgi/framework/BundleActivator.html">BundleActivator</a>. When the bundle is activated it calls methods found in the class dynamically. This exposes two methods that allow us to register and unregister services programmtically. Lets change that App.java class that sits in the main level to be our Activator.</p>

<p>First rename App.java to SimpleActivator.java (It should be SimpleStringGreeterActivator buts thats too verbose for the tutorial right now). Then change it to looks like the following:</p>

<figure class='code'><figcaption><span>Greeter Activator Class </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleActivator</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleActivator</span> <span class="kd">implements</span> <span class="n">BundleActivator</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// What to do when it starts</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// What to do when it stops</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>See the two methods it exposed? We will put some code in here in a second, but before we forget lets add the appropriate manifest entry so that the framework knows where this is. In the plugin that we set up earlier add this element to the instructions element:</p>

<figure class='code'><figcaption><span>Maven Plugin Activator Instruction </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Bundle-Activator&gt;</span>org.bhn.training.SimpleActivator<span class="nt">&lt;/Bundle-Activator&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This manifest entry tells the framework what class the activator is in so it can dynamically call the interface methods start and stop for it. If we build and checkout the manifest now we will see:</p>

<figure class='code'><figcaption><span>Manifest Revisited </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Manifest-Version: 1.0
</span><span class='line'>Bnd-LastModified: 1376421388797
</span><span class='line'>Build-Jdk: 1.6.0_51
</span><span class='line'>Built-By: JSDowning
</span><span class='line'>Bundle-Activator: org.bhn.training.SimpleActivator
</span><span class='line'>... bunch of other stuff ...</span></code></pre></td></tr></table></div></figure>


<p>Good, we can see our Activator in there, lets put some code in it. The steps involved in registering a service are pretty simple.</p>

<ol>
<li>We get a reference to the BundleContext</li>
<li>We use registerService to keep the ServiceRegistration</li>
<li>When done we use the ServiceRegistration to unregister the service.</li>
</ol>


<figure class='code'><figcaption><span>Fully Functioning Activator </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.impl.SimpleStringGreeterImpl</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleActivator</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.ServiceRegistration</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleActivator</span> <span class="kd">implements</span> <span class="n">BundleActivator</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">ServiceRegistration</span> <span class="n">registration</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
</span><span class='line'>      <span class="n">registration</span> <span class="o">=</span> <span class="n">bundleContext</span>
</span><span class='line'>          <span class="o">.</span><span class="na">registerService</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Greeter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
</span><span class='line'>          <span class="k">new</span> <span class="nf">SimpleStringGreeterImpl</span><span class="o">(),</span><span class="n">props</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">registration</span><span class="o">.</span><span class="na">unregister</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the gist of this is that the service registers our Implementation class under the string name of the interface. This means anyone who wants a reference to this service can use the interface to get it. It&rsquo;s important to note that right now, it won&rsquo;t work because even though our interfaces are public, they won&rsquo;t be exposed in the framework. We must explicitly tell OSGi to expose our interfaces. Let&rsquo;s do that so we can call it later. The easiest way to do this is to export the interfaces namespace, so lets add this line to the plugin:</p>

<figure class='code'><figcaption><span>Exposing Our API In Maven </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Export-Package&gt;</span>org.bhn.training.api<span class="nt">&lt;/Export-Package&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This tells the framework to allow other bundles to see this namespace. Without this there would be know way a caller could get a reference to our service, because there would be no interface found called org.bhn.training.api.Greeter to lookup. Notice that the impl class is never exposed. There is absolutely NO method here that someone could instantiate a new SimpleStringGreetingImpl(). Even though its public, it&rsquo;s not exposed by the framework. This gets to the heart of why OSGi is so modular. It&rsquo;s relatively impossible to couple your classes together without some seriously bad practices.</p>

<h2>Deploy Our Bundle</h2>

<p>We are going to use the command line to deploy it, but you don&rsquo;t have to. If you still have the web interface from the previous tutorial you can update and install it from there as well. But from the command line it looks like:</p>

<figure class='code'><figcaption><span>Deploying A Bundle Using Felix Command Line </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g! felix:install file:/Users/PlasmaTrout/Projects/greeter-bundle/target/greeter-bundle-1.0-SNAPSHOT.jar
</span><span class='line'>Bundle ID: 13
</span><span class='line'>
</span><span class='line'>g! felix:start 13</span></code></pre></td></tr></table></div></figure>


<h2>Create A Gogo Shell Command</h2>

<p>It&rsquo;s started but we still have no way of seeing it. Lets create a way to actually call it. In other tutorials we talked about the Gogo shell and how extensible it is, but lets create a new command just to demonstrate how easy it is to expose our interface as a command as well. All we need to do to make this happen is add two new properties to our service. Lets change our startup to be:</p>

<figure class='code'><figcaption><span>Creating A Gogo Shell Command </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
</span><span class='line'>      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;osgi.command.scope&quot;</span><span class="o">,</span><span class="s">&quot;tutorial&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;osgi.command.function&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;greet&quot;</span> <span class="o">});</span>
</span><span class='line'>      <span class="n">registration</span> <span class="o">=</span> <span class="n">bundleContext</span>
</span><span class='line'>              <span class="o">.</span><span class="na">registerService</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Greeter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
</span><span class='line'>              <span class="k">new</span> <span class="nf">SimpleStringGreeterImpl</span><span class="o">(),</span><span class="n">props</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using these two properties, you can expose any class method as a Gogo shell command. The first specifies the scope of the command, which is just a clever way to avoid conflicts with other command named the same. The second is the method to call and command name wrapped it one. So calling <strong>tutorial:greet</strong> should cause a hello world to appear. Lets <strong>mvn package</strong> again then run an update on our bundle. My bundle was 13 so typing <strong>update 13</strong> will reinstall from the installed location. Now if you look at your command list by typing <strong>help</strong> you should have a <strong>tutorial:greet</strong> command visible. Type it and see what happens:</p>

<figure class='code'><figcaption><span>Executing Our New Command </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g! tutorial:greet
</span><span class='line'>Hello World!
</span><span class='line'>g!</span></code></pre></td></tr></table></div></figure>


<p>This still isn&rsquo;t a very good test of the service from a consumer standpoint. You really would want to test that the service is in the registry and that you can ask for it by interface name. If you want to do that, create a new package named org.bhn.training.commands and put a class called GreeterCommands in it. Should end up like the following:</p>

<figure class='code'><figcaption><span>Making A Better Command Class </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">commands</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.bhn.training.api.Greeter</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.ServiceReference</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">osgi</span><span class="o">.</span><span class="na">framework</span><span class="o">.</span><span class="na">FrameworkUtil</span><span class="o">.*;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreeterCommands</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">greet</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">BundleContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">getBundle</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Greeter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">getBundleContext</span><span class="o">();</span>
</span><span class='line'>        <span class="n">ServiceReference</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getServiceReference</span><span class="o">(</span>
</span><span class='line'>                <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Greeter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Greeter</span> <span class="n">greeter</span> <span class="o">=</span> <span class="o">(</span><span class="n">Greeter</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">ref</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">greeter</span><span class="o">.</span><span class="na">greet</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code shows a programmatic method to call a service from code. We will expound on this somewhat later because there is a lot easier ways of doing this, but this way represents the classic steps to OSGi service calling:</p>

<ol>
<li>Get the BundleContext</li>
<li>Get the ServiceReference</li>
<li>Use the ServiceReference to get the Service</li>
<li>Call The Service</li>
</ol>


<p>Next we need ot change the startup to register two services instead of one like so:</p>

<figure class='code'><figcaption><span>Registering Two Services </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Hashtable</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
</span><span class='line'>      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;osgi.command.scope&quot;</span><span class="o">,</span><span class="s">&quot;tutorial&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;osgi.command.function&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;greet&quot;</span> <span class="o">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Hashtable</span> <span class="n">noprops</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">registration</span> <span class="o">=</span> <span class="n">bundleContext</span>
</span><span class='line'>              <span class="o">.</span><span class="na">registerService</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Greeter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
</span><span class='line'>              <span class="k">new</span> <span class="nf">SimpleStringGreeterImpl</span><span class="o">(),</span><span class="n">noprops</span><span class="o">);</span>
</span><span class='line'>        <span class="n">command</span> <span class="o">=</span> <span class="n">bundleContext</span><span class="o">.</span><span class="na">registerService</span><span class="o">(</span>
</span><span class='line'>          <span class="n">org</span><span class="o">.</span><span class="na">bhn</span><span class="o">.</span><span class="na">training</span><span class="o">.</span><span class="na">commands</span><span class="o">.</span><span class="na">GreeterCommands</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">GreeterCommands</span><span class="o">(),</span><span class="n">props</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now after an <strong>felix:update</strong> you can call your command again and witness that its actually calling the service using the OSGi API.</p>

<p><em>Note: After looking at the Activator imagine you have more than two services to register. Now picture 10 or more. It can get a little verbose to register all these programmatically. Let&rsquo;s fix that. In the next tutorial we will convert this to use an xml file to declare the service components. This will improve the readability considerably.</em></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/14/apache-felix-starting-from-scratch/">Apache Felix - Starting From Scratch</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-14T14:20:00-04:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tutorial is designed to provide guidance on downloading, installing and configuring Apache Felix for use in other classroom labs. It&rsquo;s designed to give the bare bones and provide a starting point needed in the remainder of the tutorials that will be given on Apache Felix. Its can also easily be adapter for classroom demonstrations and hackathons.</p>

<h2>Audience</h2>

<p>Typically, this is Lab #1 in a classroom environment, however anyone that wishes can use this tutorial to set up their own Apache Felix envinroment for learning OSGi. The typical audience already understands what OSGi is and that Apache Felix is just one implementation of an OSGi framework.</p>

<h2>What We Are Going To Do</h2>

<ol>
<li>Install Apache Felix</li>
<li>Start It Up</li>
<li>Install A Web Console</li>
<li>Add Some Bundles</li>
</ol>


<h2>Installing Apache Felix</h2>

<p>Apache Felix is pretty easy to get started with regardless of what discipline of development you come from. The first step is to get your hands on the binary, which at time of write is found at the following URL:</p>

<p><a href="http://felix.apache.org/downloads.cgi">http://felix.apache.org/downloads.cgi</a></p>

<p><em>For these examples we will use the zip version since it will translate regardless of what operating system your are using.</em></p>

<p>Before we get moving let me explain that these labs were designed to mimic the framework you will see most often in Adobe CQ, which is why we are using Apache Felix here. But there are a plethora of OSGi frameworks to choose from and you may have fun downloading and trying a few others out. Keep in mind, while some of the other frameworks will make things considerably easier, they may in fact, deviate from the OSGi Alliance&rsquo;s original specifications. If we work in Felix we are almost certain to be R4 compliant. Let&rsquo;s get started.</p>

<p>Make a directory for yourself somewhere where we can work as a scratchpad. I typically move my files from the Download directory so they dont get lost in the mass of downloads that end up in there. I usually do something like:</p>

<figure class='code'><figcaption><span>Sample Path </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$HOME/projects/apache-felix</span></code></pre></td></tr></table></div></figure>


<p>Once you have your structure set up, mv the file (or copy) from the Downloads directory to your new location and unzip it. Mileage may vary on Windows devices but on MacOS set up can be accomplished by issuing the following commands:</p>

<figure class='code'><figcaption><span>Installation </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd $HOME/projects
</span><span class='line'>mkdir apache-felix
</span><span class='line'>cd apache-felix/
</span><span class='line'>cp /Users/&lt;&lt;me>>/Downloads/org.apache.felix.main.distribution-4.2.1.zip .
</span><span class='line'>unzip org.apache.felix.main.distribution-4.2.1.zip</span></code></pre></td></tr></table></div></figure>


<h2>Start It Up</h2>

<p>After its unzipped youll notice an felix-framework-x-x-x folder (depending on what distribution you have). If you change directory into that folder you can explore the structure of this bare bones install. We wont be deep diving into all of these directories just yet, just notice they are there. If you decide to explore, be sure not to edit them. The framework boots off of these directories and uses them to index and locate classes. Changing them around is not a great idea. So lets start up Felix, if you type:</p>

<figure class='code'><figcaption><span>Running Felix </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -jar bin/felix.jar</span></code></pre></td></tr></table></div></figure>


<p>You should be welcomed with a running framework console that looks like:</p>

<figure class='code'><figcaption><span>The Gogo Shell </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>____________________________
</span><span class='line'>Welcome to Apache Felix Gogo
</span><span class='line'>
</span><span class='line'>g!</span></code></pre></td></tr></table></div></figure>


<p>What this? Well by default, all that comes with Felix, as far as administration is concerned, is a console. Now, dont get the wrong impression, this is one powerful console thats staring back at you. It just doesnt seem like it right now (especially since the terminal apparently is some sort of strange dance style).</p>

<p>The GOGO shell (the dance style in question), is a standard Apache shell that you will see on both Felix and Karaf.  Karaf however, does have a ANSI color one which makes it a little more exciting (and by exciting I mean 1990&rsquo;s IRC exciting). The g! prompt is the surefire mechism to recognize this shell over the others.</p>

<p>So we came all this way, we might as well issue some commands. Type in the following to the shell:</p>

<figure class='code'><figcaption><span>List Bundles Command </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>felix:lb</span></code></pre></td></tr></table></div></figure>


<p>The command lb is a felix command for listing all of the bundles installed in Felix. The felix prefix is sort of a namespace qualifier. It exists primarily in the case two different command bundles use the same command name. But since they come with Felix, there are also aliased directly on the console. So typing lb will work as well. As far as instruction go, however, I will almost always prefix the command. My rationale is that in other systems, like Apache Karaf, it will be mandatory since so many open source bundles exist in the framework and you will need to get used to it anyways.</p>

<p>The output of our <strong>felix:lb</strong> command should have resembled the following:</p>

<figure class='code'><figcaption><span>List Bundles Output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g! felix:lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>    0|Active     |    0|System Bundle (4.2.1)
</span><span class='line'>    1|Active     |    1|Apache Felix Bundle Repository (1.6.6)
</span><span class='line'>    2|Active     |    1|Apache Felix Gogo Command (0.12.0)
</span><span class='line'>    3|Active     |    1|Apache Felix Gogo Runtime (0.10.0)
</span><span class='line'>    4|Active     |    1|Apache Felix Gogo Shell (0.10.0)
</span><span class='line'>g!</span></code></pre></td></tr></table></div></figure>


<p>For those of you that have browsed another Felix installation, possibly Sling or Adobe CQ, you probably are asking Yeah right, where are the other 200+ bundles?. Well this is it, the default Felix framework operates on these 5 bundles and doesnt need much else. You can start developing right now on these building whatever you heart desires.</p>

<p>So, what else can you do on the console? Well type help in the console and you should get back a list of all of the available commands out of the box. The console should happily respond:</p>

<figure class='code'><figcaption><span>Help Command Output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>... some stuff ...
</span><span class='line'>felix:install
</span><span class='line'>felix:lb
</span><span class='line'>felix:log
</span><span class='line'>felix:ls
</span><span class='line'>felix:refresh
</span><span class='line'>felix:resolve
</span><span class='line'>felix:start
</span><span class='line'>felix:stop
</span><span class='line'>... more stuff ...</span></code></pre></td></tr></table></div></figure>


<p>Before you try these out, its important to note that the help system can also give you some pretty detailed information on each command. For instance type <strong>help felix:ls</strong> and look at the output:</p>

<figure class='code'><figcaption><span>Help List Output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g! help felix:ls
</span><span class='line'>
</span><span class='line'>ls - get current directory contents
</span><span class='line'>   scope: felix
</span><span class='line'>   parameters:
</span><span class='line'>      CommandSession   automatically supplied shell session
</span><span class='line'>
</span><span class='line'>ls - get specified path contents
</span><span class='line'>   scope: felix
</span><span class='line'>   parameters:
</span><span class='line'>      CommandSession   automatically supplied shell session
</span><span class='line'>      String   path with optionally wildcarded file name
</span><span class='line'>g!</span></code></pre></td></tr></table></div></figure>


<p>Then try it:</p>

<figure class='code'><figcaption><span>List Command Output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g! felix:ls
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/bin
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/bundle
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/conf
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/DEPENDENCIES
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/doc
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/felix-cache
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/LICENSE
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/LICENSE.kxml2
</span><span class='line'>/Users/Me/ExternalLibraries/apache-felix-bare/felix-framework-4.2.1/NOTICE
</span><span class='line'>
</span><span class='line'>g!</span></code></pre></td></tr></table></div></figure>


<p>Thats all there is really to understanding the GOGO shell. Now mastering all of these commands would be a good idea, but its not really needed. That is unless you want to stay lightweight, say on a mobile device or micro-board type installation. For the desktop environments there is a web based console (strategically named WebConsole :) that we can employ to make this a little easier for us.</p>

<p>Before you install it, take a look at the help on the <strong>felix:install</strong> command.</p>

<h2>Installing A Web Console</h2>

<p>After executing a <strong>help felix:install</strong>, you will notice that the command is scoped to the felix prefix and takes a collection of parameters. This means if we really wanted to we could install multiple things at once. Secondly, note it takes a URL to a file and not just a file path. This means its more than capable of installing over the internet. Lets take advantage of the that to install the web console and a http server into the framework. In the console issue the command:</p>

<figure class='code'><figcaption><span>Installing The Web Console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.webconsole-4.2.0-all.jar</span></code></pre></td></tr></table></div></figure>


<p>the web console requires a web server so lets install jetty</p>

<figure class='code'><figcaption><span>Installing Jetty </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.http.jetty-2.2.0.jar</span></code></pre></td></tr></table></div></figure>


<p>Once the download and install is completed, the console should return back a Bundle ID: X (where X is a number). This represent the bundle id that you just installed and will use to find out more information about the bundle and start/stop it. Now do an <strong>felix:lb</strong> and look at your list. You should have two bundles in the installed state.
In order to start up our console we will first need to start the Jetty bundle then our Web Management Console bundle. To do that type the command <strong>felix:start X</strong> (where x is the number of the Jetty bundle).</p>

<figure class='code'><figcaption><span>Starting Jetty and Web Console </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>g! lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>    0|Active     |    0|System Bundle (4.2.1)
</span><span class='line'>    1|Active     |    1|Apache Felix Bundle Repository (1.6.6)
</span><span class='line'>    2|Active     |    1|Apache Felix Gogo Command (0.12.0)
</span><span class='line'>    3|Active     |    1|Apache Felix Gogo Runtime (0.10.0)
</span><span class='line'>    4|Active     |    1|Apache Felix Gogo Shell (0.10.0)
</span><span class='line'>    6|Installed  |    1|Apache Felix Web Management Console (All In One) (4.2.0.all)
</span><span class='line'>    7|Installed  |    1|Apache Felix Http Jetty (2.2.0)
</span><span class='line'>g! felix:start 7
</span><span class='line'>g! [INFO] Started jetty 6.1.x at port(s) HTTP:8080
</span><span class='line'>
</span><span class='line'>g! felix:start 6
</span><span class='line'>g!</span></code></pre></td></tr></table></div></figure>


<p>Do the same for the Web Management Console. Then go to <a href="http://localhost:8080">http://localhost:8080</a> and see if you get a subtle Jetty 404 ERROR. Believe it or not, this 404 is actually a good thing. It tells us Jetty is running and we have no pages on the root. We do, however, have servlets in the path /system/console now. So try going to this URL using a username of admin and a password of admin:</p>

<p><a href="http://localhost:8080/system/console/bundles">http://localhost:8080/system/console/bundles</a></p>

<p>After logging in, you should land on the bundles page. This page is probably the most important of the pages on the web console and you will use it more than the others in you quest to become a master bundle developer. The reasoning is simple, this is where you go to upload, start, stop and examine bundles. There are some important OSGi foundational things to take note of on this page so lets review a few of them.</p>

<h3>Every Bundle Has A Unique Id</h3>

<p>Yep. Thats it there in the Id column. They stay pretty simple as integers. Definitely prevents a lot of typing when using the console.</p>

<h3>Bundle 0 belongs to the framework and cannot be stopped or started</h3>

<p>We should have reviewed earlier that bundle 0 belongs to the framework. Heck, it really is the running framework which explains why it doesnt have a stop button available for it. Its version number tells you the version of the framework you are running and if you ever see this bundle stopped someone is playing a trick on you because the web console wouldnt be available if it was.</p>

<h3>Bundle 0 only exports the bare essentials and only the standard Java libraries</h3>

<p>If you click the right arrow expander next to the name you can see a ton of more information (probably more that youd like) about the system bundle. As youd expect this bundle exports all of the core Java libraries and a few OSGi specific ones. The best part is that a significant amount of XML libraries are exported to, so always check here before exporting your own.</p>

<h3>Bundle 0 must start first</h3>

<p>Notice the start level field. Its blank? Yep. Thats because bundle 0 must start first and therefore is really start level 0.</p>

<h3>Bundle 0 must have no dependencies</h3>

<p>Now take a look at the Imported Packaged section. Notice that the system bundle imports nothing. It has no dependencies. At all. None.</p>

<h3>Bundles have states</h3>

<p>So the status column shows what state the entire bundle is in. All of ours should show active at this point.</p>

<h3>Bundles can be started and stopped independently of each other</h3>

<p>Notice the stop button next to each bundle. This is where you can stop, start, or delete them from the framework.</p>

<p><em>NOTE: Bundle 0 has a lot to it. Look around. It also registers two services, they are two interfaces named PackageAdmin and StartLevel.</em></p>

<p>Well theres the 1 dollar tour of the bundles section of the app. Lets take a look at the rest of the menu structure
Under OSGi we get Bundles (which is where we are), Configuration, Log Service and Services (Image 3.11). Ignore the Status and Web Console top level menus for now. They really just drive to informational content anyways. The stock OSGi sections of this menu apply to some UI pieces we havent installed yet. If you try to go to Configuration or Log Service you may notice they just tell you they arent installed. Let click on Services.</p>

<h2>Add Some More Bundles</h2>

<p>So that really the bare minimum install, however there are some Felix provided bundles you may want to browse yourself and install at will. You can find them at:</p>

<p><a href="http://felix.apache.org/downloads.cgi">http://felix.apache.org/downloads.cgi</a> towards the bottom.</p>

<p>Lets continue our class setup with the following ones (They are mostly to enhance our web console and will provide good practice):</p>

<figure class='code'><figcaption><span>Adding More Features Practice </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.configadmin-1.6.0.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.log-1.0.1.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.metatype-1.0.6.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.dependencymanager-3.1.0.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.eventadmin-1.3.2.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.deploymentadmin-0.9.4.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.webconsole.plugins.event-1.0.2.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.webconsole.plugins.packageadmin-1.0.0.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.scr-1.6.2.jar
</span><span class='line'>felix:install http://mirror.switch.ch/mirror/apache/dist/felix/org.apache.felix.webconsole.plugins.ds-1.0.0.jar</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/08/15/apache-felix-paxexam-and-unit-testing-felix-bundles/">Apache Felix - Pax Exam and Unit Testing Felix Bundles</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/15/apache-felix-modifying-our-first-bundle-for-declarative-services/">Apache Felix - Modifying Our First Bundle for Declarative Services</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/15/apache-felix-first-bundle/">Apache Felix - First Bundle the Programmatic Way</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/14/apache-felix-starting-from-scratch/">Apache Felix - Starting From Scratch</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/PlasmaTrout">@PlasmaTrout</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'PlasmaTrout',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/114996005873710645329?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - jeff.downing@latchd.com -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'aggrolearning';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
