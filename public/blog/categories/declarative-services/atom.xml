<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Declarative Services | CodeAffectionado]]></title>
  <link href="http://www.codeaffectionado.com/blog/categories/declarative-services/atom.xml" rel="self"/>
  <link href="http://www.codeaffectionado.com/"/>
  <updated>2013-08-17T14:01:26-04:00</updated>
  <id>http://www.codeaffectionado.com/</id>
  <author>
    <name><![CDATA[jeff.downing@latchd.com]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Apache Felix - Modifying Our First Bundle For Declarative Services]]></title>
    <link href="http://www.codeaffectionado.com/blog/2013/08/15/apache-felix-modifying-our-first-bundle-for-declarative-services/"/>
    <updated>2013-08-15T15:53:00-04:00</updated>
    <id>http://www.codeaffectionado.com/blog/2013/08/15/apache-felix-modifying-our-first-bundle-for-declarative-services</id>
    <content type="html"><![CDATA[<p>In our previous <a href="/blog/2013/08/15/apache-felix-first-bundle/">example tutorial</a> we created an OSGi bundle in a programmatic fashion. In that bundle we registered two services into the service registry. While rather simple in implementation, the solution did depend heavily on use of the Activator class. And since only one Activator can be defined in a bundle, registering even more services would present a significant challenge on readability. We are going to neaten this up a bit and use some features of the R4 compendium known as Declarative Services. We will expound on it a little as we go along, but I encourage you to read the specifications on the <a href="http://www.osgi.org/Download/HomePage">OSGi Alliances Site</a>.</p>

<p>If you haven&rsquo;t done the first bundle tutorial mentioned above you can grab the source at:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Git Hub Quick Start <a href="https://github.com/PlasmaTrout/greeter-bundle-lab3">https://github.com/PlasmaTrout/greeter-bundle-lab3</a> GitHub </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git@github.com:PlasmaTrout/greeter-bundle-lab3.git
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Requirements</h2>

<ul>
<li>Apache Felix (See <a href="/blog/2013/08/14/apache-felix-starting-from-scratch/">Starting From Scratch</a>)</li>
<li>Apache Maven</li>
<li>IDE Of Choice (Preferably IntelliJ IDEA)</li>
<li>Internet Connection (For Maven Repositories)</li>
<li>GIT (Needed To Pull Previous Project)</li>
</ul>


<h2>Audience</h2>

<p>Typically, this is Lab #3 in a classroom environment, however anyone that wishes can use this tutorial to create a tutorial bundle. The typical audience already understands what OSGi is and that Apache Felix is just one implementation of an OSGi framework.</p>

<h2>What We Are Going To Do</h2>

<ol>
<li>Remove The Activator From The Project</li>
<li>Add A XML File For The Greeter Service To The Resources Directory</li>
<li>Add Another XML File For The Greet Command To The Resources Directory</li>
<li>Build, Deploy And Test</li>
</ol>


<h2>Remove The Activator From The Project</h2>

<p>So let&rsquo;s delete that Activator now. Just completely wipe it out of the project. When your finished with that edit your POM.xml and completely wipe out this line (we don&rsquo;t need it anymore):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Remove This Activator Line </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="ni">&amp;lt;</span>Bundle-Activator&gt;org.bhn.training.SimpleActivator<span class="ni">&amp;lt;</span>/Bundle-Activator&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>If you have any doubts as to whether its gone after a new build, just peek into the JAR file and make sure its gone. Mine looks something like this now (note no activator is inside the bundle):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Sample JAR Contents Now </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/api/
</span><span class='line'>155 Wed Aug 14 11:16:32 EDT 2013 org/bhn/training/api/Greeter.class
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/commands/
</span><span class='line'>1132 Wed Aug 14 11:16:32 EDT 2013 org/bhn/training/commands/GreeterCommands.class
</span><span class='line'>0 Wed Aug 14 11:18:10 EDT 2013 org/bhn/training/impl/
</span><span class='line'>482 Wed Aug 14 11:16:32 EDT 2013 org/bhn/training/impl/SimpleStringGreeterImpl.class</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Add A XML File For The Greeter Service To The Resources Directory</h2>

<p>Because we are using maven, we need to make some new directories and maven knows about so we can include resources into our project. Make a resources dir under main and then put a new dir under the resources dir called OSGI-INF. Our new directories path should look like:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Add A New Resource Path </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;&lt;Project>>/src/main/resources/OSGI-INF</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now in the OSGI-INF directory, lets create a new file called greetercomponent.xml. The name is somewhat irrelevant, however I would name it something that indicates what component it is for. The reason is, each service will be in its own xml file. After a while component1, component2 and component3 won&rsquo;t help developers quickly find its configuration.</p>

<p>Now we are going to do the same job that we did in the Activator in a declarative manner. Modify your greetercomponent.xml file to look like the following:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Add A Declarative Services Component File (greetercomponent.xml)</span> <a href='/downloads/code/greetercomponent.xml'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;scr:component</span> <span class="na">name=</span><span class="s">&quot;GreeterComponent&quot;</span>
</span><span class='line'>               <span class="na">xmlns:scr=</span><span class="s">&quot;http://www.osgi.org/xmlns/scr/v1.2.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;implementation</span> <span class="na">scr:class=</span><span class="s">&quot;org.bhn.training.impl.SimpleStringGreeterImpl&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;service&gt;</span>
</span><span class='line'>        <span class="nt">&lt;scr:provide</span> <span class="na">interface=</span><span class="s">&quot;org.bhn.training.api.Greeter&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/service&gt;</span>
</span><span class='line'><span class="nt">&lt;/scr:component&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>So interpreting this file is rather straight-forward. We are first declaring a component. What&rsquo;s a component. Well a component is really just a Java class that is declared in an XML document. Very similar to the concepts of beans if you are used to other Java terminologies. It has a name just for management in the framework. You can install other web consoles that help manage them by their component name.</p>

<p>Then we tell the component what its implementation class is, so it can create it when its needed.</p>

<p>Then we create a service and tell it what interface to provide, that is, register for us. That&rsquo;s all there really is to a simple service. However, before we can use this xml file, we need to tell the maven plugin to add a manifest entry for where to find it. That entry is known as the Service-Component entry. In our POM in the instructions for our bundle plugin lets add the following line:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Tell The Bundle The File Exists </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="ni">&amp;lt;</span>Service-Component&gt;OSGI-INF/greetercomponent.xml<span class="ni">&amp;lt;</span>/Service-Component&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>With this line in the file you are ready to deploy to your framework. But before you do, you need to make sure another specific bundle is installed in the container. It&rsquo;s called the SCR Declarative Services bundle and it should be running. If not not sweat, pull up your OSGi console and enter:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Install Service Component Registry Bundle </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>felix:install &lt;a href="http://mirror.sdunix.com/apache//felix/org.apache.felix.scr-1.6.2.jar">http://mirror.sdunix.com/apache//felix/org.apache.felix.scr-1.6.2.jar&lt;/a>
</span><span class='line'>felix:start X (where x is the number of the bundle)</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>After you deploy your bundle. Pull up the <a href="http://localhost:8080/system/console">web console</a> and expand it. You should see your new manifest entry is present and you should have a new service id registered. This is a pretty good indication that everything went as planned, but lets add our command otherwise testing it won&rsquo;t be too easy.</p>

<h2>Add Another XML File For The Greet Command To The Resources Directory</h2>

<p>So lets add one more component file to the OSGI-INF directory. Lets add a greetcommandcomponent.xml file. And do something similar as the above example to register it. However, in this component, we need properties to set upon activation so we have some new elements to add to the definition:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Add A Command Declarative Services Component File (greetcommandcomponent.xml)</span> <a href='/downloads/code/greetcommandcomponent.xml'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;scr:component</span> <span class="na">name=</span><span class="s">&quot;GreetCommandComponent&quot;</span>
</span><span class='line'>               <span class="na">xmlns:scr=</span><span class="s">&quot;http://www.osgi.org/xmlns/scr/v1.2.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;implementation</span> <span class="na">scr:class=</span><span class="s">&quot;org.bhn.training.commands.GreeterCommands&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;service&gt;</span>
</span><span class='line'>        <span class="nt">&lt;scr:provide</span> <span class="na">interface=</span><span class="s">&quot;org.bhn.training.commands.GreeterCommands&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;osgi.command.scope&quot;</span> <span class="na">value=</span><span class="s">&quot;tutorialds&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;osgi.command.function&quot;</span><span class="nt">&gt;</span>greet<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/scr:provide&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/service&gt;</span>
</span><span class='line'><span class="nt">&lt;/scr:component&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Then we just add this to our manifest by changing our Service-Component entry to:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Add A Second Component File To The Maven Plugin </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="ni">&amp;lt;</span>Service-Component&gt;OSGI-INF/greetercomponent.xml,<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span>        OSGI-INF/greetcommandcomponent.xml<span class="ni">&amp;lt;</span>/Service-Component<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Build, Deploy and Test</h2>

<p>So package this guy up with a <strong>mvn package</strong> and then deploy using your method of choice (for this one I used the web console personally). After its deployed and started you should see a new command in our console for <strong>tutorialds:greet</strong> and be able to call it. I did have some exceptions during the making of this tutorial and you may experience the same. The few things that happened to me were:</p>

<h3>IllegalStateExceptions</h3>

<p><em>ERROR: greeter-bundle (15): [GreeterComponent] Cannot register Component
java.lang.IllegalStateException: Invalid BundleContext</em></p>

<p>This occured mainly because I had a typo in one of the component files which confused Felix into writing some properties it shouldn&rsquo;t have. I think the name attribute was missing from one of the properties. However, even after fixing it, the exception stayed there until I restarted the whole framework.</p>

<h3>XmlParseExceptions</h3>

<p>Typically they come in a variety of flavors and they are usually due to badly formed xml documents. Mine came from a example in the R4 compendium that had a declarative services entry as the following:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Malformed Header </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;xml</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span> <span class="na">encoding=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Which I pasted and didn&rsquo;t check, but its really supposed to be:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Standard Header </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="ni">&amp;lt;</span>?xml version=<span class="ni">&amp;ldquo;</span>1.0<span class="ni">&amp;rdquo;</span> encoding=<span class="ni">&amp;ldquo;</span>UTF-8<span class="ni">&amp;rdquo;</span>?&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>In the next tutorial I think we will kill the command on this bundle and then add PaxExam so we can unit test our product. Generating commands for each bundle to test them is not a feasible option for long term sustainability. PaxExam will allow us to run Felix as a part of our Maven test lifecycle and test our bundle.</p>
]]></content>
  </entry>
  
</feed>
